{
  "entities": {
    "UserProfile": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserProfile",
      "type": "object",
      "description": "Represents a user profile within the PermitPilot application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user profile."
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "phone": {
          "type": "string",
          "description": "User's phone number."
        },
        "companyName": {
          "type": "string",
          "description": "Name of the user's company."
        }
      },
      "required": [
        "id",
        "firstName",
        "lastName",
        "email"
      ]
    },
    "Municipality": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Municipality",
      "type": "object",
      "description": "Represents a municipality with its permit requirements.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the municipality."
        },
        "name": {
          "type": "string",
          "description": "Name of the municipality."
        },
        "state": {
          "type": "string",
          "description": "State where the municipality is located."
        },
        "permitRequirements": {
          "type": "string",
          "description": "Details of the permit requirements for the municipality."
        }
      },
      "required": [
        "id",
        "name",
        "state"
      ]
    },
    "Permit": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Permit",
      "type": "object",
      "description": "Represents a specific permit application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the permit."
        },
        "userId": {
          "type": "string",
          "description": "Reference to UserProfile. (Relationship: UserProfile 1:N Permit)"
        },
        "municipalityId": {
          "type": "string",
          "description": "Reference to Municipality. (Relationship: Municipality 1:N Permit)"
        },
        "permitType": {
          "type": "string",
          "description": "Type of permit (e.g., building, electrical, plumbing)."
        },
        "applicationDate": {
          "type": "string",
          "description": "Date the permit application was submitted.",
          "format": "date-time"
        },
        "status": {
          "type": "string",
          "description": "Current status of the permit (e.g., pending, approved, rejected)."
        },
        "estimatedCompletionDate": {
          "type": "string",
          "description": "Estimated completion date for the permit process.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "municipalityId",
        "permitType",
        "applicationDate",
        "status"
      ]
    },
    "Checklist": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Checklist",
      "type": "object",
      "description": "Represents a checklist associated with a permit, generated with AI assistance.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the checklist."
        },
        "permitId": {
          "type": "string",
          "description": "Reference to Permit. (Relationship: Permit 1:N Checklist)"
        },
        "description": {
          "type": "string",
          "description": "Description of what this checklist contains."
        },
        "items": {
          "type": "array",
          "description": "List of checklist items. Each item must contain a description and status",
          "items": {
            "type": "string"
          }
        },
        "generatedByAI": {
          "type": "boolean",
          "description": "Indicates if the checklist was generated by AI."
        }
      },
      "required": [
        "id",
        "permitId"
      ]
    },
    "Document": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Document",
      "type": "object",
      "description": "Represents a document associated with a permit application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the document."
        },
        "permitId": {
          "type": "string",
          "description": "Reference to Permit. (Relationship: Permit 1:N Document)"
        },
        "filename": {
          "type": "string",
          "description": "Name of the document file."
        },
        "fileType": {
          "type": "string",
          "description": "Type of the document file (e.g., PDF, image)."
        },
        "uploadDate": {
          "type": "string",
          "description": "Date the document was uploaded.",
          "format": "date-time"
        },
        "url": {
          "type": "string",
          "description": "URL where the document is stored."
        }
      },
      "required": [
        "id",
        "permitId",
        "filename",
        "fileType",
        "uploadDate",
        "url"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/userProfiles/{userId}",
        "definition": {
          "entityName": "UserProfile",
          "schema": {
            "$ref": "#/backend/entities/UserProfile"
          },
          "description": "Stores user profile information. Accessible only to the user themselves.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user."
            }
          ]
        }
      },
      {
        "path": "/municipalities/{municipalityId}",
        "definition": {
          "entityName": "Municipality",
          "schema": {
            "$ref": "#/backend/entities/Municipality"
          },
          "description": "Stores municipality data and permit requirements. Publicly accessible.",
          "params": [
            {
              "name": "municipalityId",
              "description": "The unique identifier of the municipality."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/permits/{permitId}",
        "definition": {
          "entityName": "Permit",
          "schema": {
            "$ref": "#/backend/entities/Permit"
          },
          "description": "Stores permit applications for each user. `userId` in the path ensures ownership and simplifies security rules. Includes the municipalityId for efficient querying.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the permit."
            },
            {
              "name": "permitId",
              "description": "The unique identifier of the permit."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/permits/{permitId}/checklists/{checklistId}",
        "definition": {
          "entityName": "Checklist",
          "schema": {
            "$ref": "#/backend/entities/Checklist"
          },
          "description": "Stores checklists associated with permits. Path-based ownership (`userId`, `permitId`) simplifies security rules. Includes a flag `generatedByAI`.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the permit."
            },
            {
              "name": "permitId",
              "description": "The unique identifier of the permit."
            },
            {
              "name": "checklistId",
              "description": "The unique identifier of the checklist."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/permits/{permitId}/documents/{documentId}",
        "definition": {
          "entityName": "Document",
          "schema": {
            "$ref": "#/backend/entities/Document"
          },
          "description": "Stores documents associated with permits. Path-based ownership (`userId`, `permitId`) simplifies security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who owns the permit."
            },
            {
              "name": "permitId",
              "description": "The unique identifier of the permit."
            },
            {
              "name": "documentId",
              "description": "The unique identifier of the document."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore data structure is designed to support the PermitPilot application's features, focusing on scalability, security, and ease of maintenance. The structure prioritizes authorization independence and aims to avoid complex rule logic by denormalizing authorization data. User profiles, municipalities, permits, checklists, and documents are stored in separate collections, with clear relationships defined through document references.\n\n- `/userProfiles/{userId}`: Stores user profile data. This is private data, so it is stored under the user's ID.\n- `/municipalities/{municipalityId}`: Stores municipality data. This data is considered public, as it is needed for all users.\n- `/users/{userId}/permits/{permitId}`: Stores permit applications associated with each user. The `userId` is part of the path, indicating ownership. This facilitates easy querying of permits owned by a specific user.  The `municipalityId` is stored on the permit document enabling queries for permits within a specific municipality without requiring a collection group query.\n- `/users/{userId}/permits/{permitId}/checklists/{checklistId}`: Stores checklists associated with each permit.  The `permitId` and `userId` are part of the path, indicating ownership.  This facilitates easy querying of checklists owned by a specific user for a specific permit.  The checklist also stores a flag indicating if the checklist was generated by AI.\n- `/users/{userId}/permits/{permitId}/documents/{documentId}`: Stores documents associated with each permit. The `permitId` and `userId` are part of the path, indicating ownership. This facilitates easy querying of documents owned by a specific user for a specific permit.\n\n**Authorization Independence:** The primary strategy for achieving authorization independence is embedding the user ID (`userId`) within the paths for permits, checklists, and documents. This eliminates the need for `get()` calls to parent documents to verify ownership.  Rules can validate `request.auth.uid == userId` to ensure only the owning user can access the data.  No membership maps are required because ownership is derived directly from the path.\n\n**QAPs (Rules are not Filters):** The structure supports secure `list` operations (QAPs) by segregating data based on ownership. The `/users/{userId}/permits/{permitId}` structure ensures that listing permits requires knowing the `userId`, thus preventing unauthorized access to other users' permits. Similarly, listing checklists and documents is restricted by the `userId` and `permitId` in their respective paths. This avoids the need for complex filtering logic in the rules, as the structure itself enforces access control."
  }
}